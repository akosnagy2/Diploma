%----------------------------------------------------------------------------
\chapter{Algoritmusok megvalósítása}
%----------------------------------------------------------------------------
Ebben a fejezetben az algoritmusok megvalósításáról, és az azokhoz használt eszközökrõl beszélek. Bemutatom a használt szimulációs környezetet, és a köré készült programok mûködését, majd leírom a szimulátorban és a valós robotokon elért eredményeimet.

%----------------------------------------------------------------------------
\section{Szimuláció -- V-REP}
%----------------------------------------------------------------------------
A robot mozgásának szimulálására a V-REP robotszimulátort használtam. A program a Coppelia Robotics terméke \cite{VREP}, amely oktatási célból ingyenesen letölthetõ és használható. Nagyon széleskörûen használható program a robotika minden ágában. Tesztelhetõ benne ipari szerelõrobotok mûködése, ahogyan az \aref{fig:vrep} ábrán is látható, felhasználható ilyen robotok programozásának oktatására is, de a mobil robotok területén is kifejezetten praktikus eszköz. Jól dokumentált, sok oktató anyaggal, példaprogramokkal együtt. Folyamatosan frissítik és új funkciókkal bõvítik a programot.

\begin{figure}[H]
\centering
\includegraphics[width=115mm, keepaspectratio]{figures/vrep.png}
\caption{A V-REP szimulációs program} 
\label{fig:vrep}
\end{figure}

\subsection{Szerver program}
Több módon is kiegészíthetõ a program mûködése. A megoldásunkban egy szerver programot hoztunk létre, mely kommunikál a V-REP egy lua szkriptjével, majd a kapott üzenet alapján mozgatja a szimulált robotot. A szerver nem csak a szimulátorral áll kapcsolatban, hanem hozzá csatlakozhatnak a különbözõ egyéb algoritmusok, ahogy az \aref{fig:vrepserver} ábrán is látható. A fejlesztés során próbáltuk  a szimulációt a robot típusától függetlenné tenni, ezt a következõképpen valósítottuk meg:

A szimuláció indulásakor a lua szkript elküldi a szimuláció módját, és a hozzá tartozó paramétereket. Innen a szerver alkalmazás eldönti, milyen paraméterek és egyéb adatok érkezhetnek, illetve, hogy melyik kliensre kell várjon. Ha a kapcsolat létrejött a kliens alkalmazással, akkor az a paramétereknek megfelelõen végzi a feladatát, majd az eredményt a szerver alkalmazáson keresztül elküldi a szimulátornak. Ez a struktúra elsõ ránézésre igen bonyolultnak tûnik, de ez a módszer biztosítja, hogy a szimulátort egyszerûen lecserélhessük egy valós robotra, vagy akár párhuzamosan is mûködhessen vele. A szerver mûködése teljes mértékben transzparens, a késõbbiekben ennek mûködését a szimulátor részének tekinthetem.

\begin{figure}[H]
\centering
\includegraphics[width=140mm, keepaspectratio]{figures/vrepserver.pdf}
\caption{Az elkészült keretrendszer blokkvázlata} 
\label{fig:vrepserver}
\end{figure}

\subsection{Kliens program}
A különbözõ kliensprogramok más-más paramétereket várnak, ezt biztosítja a szerver alkalmazás. Az idõparaméterezõ és a pályakövetõ szabályozás teszteléséhez készült egy kliens, mely a szimulátortól fogad egy elõre elkészített pályát, majd ezt újramintavételezi. Az így készült pályát visszaküldi a szimulátornak, ami kirajzolja az új pályát, majd elküldi a robot aktuális pozícióját. Innen átveszi a mûködést a pályakövetõ algoritmus, a kapott pozíciót feldolgozza, és ez alapján az elõzõ fejezetben részletezett módon kiszámítja a beavatkozó jeleket, amit visszaküld a szimulátornak. A szimulátor és a pályakövetõ alkalmazás mûködése szinkronizálva van, azaz megvárják egymást a következõ lépéssel.

\begin{figure}[H]
\centering
\includegraphics[width=125mm, keepaspectratio]{figures/DiffSimPath0RTRb.png}
\caption{Az elkészült keretrendszer nem csak autószerû robotok esetén használható. Az ábrán egy differenciális robot látható követés közben.} 
\label{fig:DiffSimRobot1RTR}
\end{figure}

A másik elkészült kliens alkalmazás a pályatervezõ program. Ez nem vár pályára a szimulátortól, csak az elõre meghatározott környezet nevére. Itt kompromisszumot kellett kötnünk, mivel a szimulátor speciális fájlformátumot tud csak kezelni, ezért közös fájlokkal dolgozik a két program, de a pályatervezõ más forrásból is elfogad pályát, így továbbra is lecserélhetõ marad a szimulátor. A pályatervezés után a mûködése teljesen megegyezik a pályakövetõtõ kliensprogramnál leírtakkal, azzal a különbséggel, hogy a pályát itt a tervezõ szolgáltatja.

\subsection{Implementáció}
A programokat a C++ nyelvet készítettem el. Azért esett a választásom erre a programozási nyelvre, mert a valós roboton, beágyazott rendszerben is könnyedén használható. A beágyazott környezet miatt igyekeztem kerülni bármiféle olyan külsõ szoftvercsomag használatát, aminek a használata problémás lehet a valós roboton. 

\begin{figure}
\centering
\includegraphics[width=140mm, keepaspectratio]{figures/frame2vrep.png}
\caption{A C*CS alkalmazása autószerû robotok esetén, szimulációs környezetben} 
\label{fig:frame2vrep}
\end{figure}

Ezek mellet a fejlesztés során igen fontos volt az objektum-orientált szemléletmód, mivel így biztosítható a legjobban a modularitás, és a késõbbi egyszerû fejlesztés, módosítás. Az implementálás során egyéb elõnyös tulajdonságát is ki tudtuk használni, ezek közül a legjelentõsebb az újrafelhasználhatóság volt. A programozás elõrehaladtával a fejlesztés sebessége is nõtt, mivel az elõzõleg elkészített kódrészleteket egyszerûen újra tudtuk használni.

%----------------------------------------------------------------------------
\section{Szimulációs eredmények}
%----------------------------------------------------------------------------
Az általam ismertetett algoritmusok szimulációs környezetben a várakozásomnak megfelelõen mûködtek. Az eredmények a következõ ábrákon láthatóak. A képek a V-REP szimulátorról készültek, az akadályokat és a pálya határait színes polygonok jelzik, a pályatervezõ által generált pályát kék színnel jelöltem, míg a robot által bejárt pályát sárgával. A robot alatt található polygon jelzi a tervezés során ténylegesen figyelembe vett robot méretét.

\begin{figure}
\centering
\includegraphics[width=140mm, keepaspectratio]{figures/frame1vrep.png}
\caption{\Aref{fig:CCSonline}. ábrán látható pálya RTR globális tervezõ esetén.} 
\label{fig:frame1vrep}
\end{figure}

A robotautó szimulálásakor jobb oldalt középen a sebesség és a gyorsulás profil látható, alatta pedig a kormányszög értéke. A felsõ grafikon itt is $m/s$ és $m^2/s$ mértékegységben szerepelnek a mennyiségek, míg a kormányszög radiánban. A grafikonok felett az autó elejére szerelt szimulált kamera képét látjuk.

\begin{figure}[H]
\centering
\includegraphics[width=140mm, keepaspectratio]{figures/frame3vrep.png}
\caption{Szûk folyosók. Autószerû robot esetén igen bonyolult pálya adódik.} 
\label{fig:frame3vrep}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=140mm, keepaspectratio]{figures/frame4vrep.png}
\caption{A tervezett pálya igen hasonló egy valós esetben végrehajtott parkoláshoz} 
\label{fig:frame4vrep}
\end{figure}